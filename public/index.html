<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Bot Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        console.log('✅ Scripts chargés');
        console.log('Socket.io disponible:', typeof io !== 'undefined');
    </script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">🤖 DCA Bot Manager</h1>
                <p class="text-gray-400">Gestion multi-paires sur Arbitrum</p>
                <p class="text-xs text-gray-500 mt-1">💡 Configuration : Modifiez le fichier .env puis redémarrez le serveur</p>
            </div>
            <div class="flex gap-4">
                <button onclick="refreshData()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold transition">
                    🔄 Actualiser
                </button>
                <button onclick="sellAllPositions()" class="px-6 py-3 bg-orange-600 hover:bg-orange-500 rounded-lg font-semibold transition">
                    💰 Vendre Tout
                </button>
                <button id="startStopBtn" onclick="toggleBot()" class="px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-semibold transition">
                    ▶️ Démarrer
                </button>
            </div>
        </div>

        <!-- Settings Panel -->
        <!-- Supprimé: Configuration via .env uniquement -->

        <!-- Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-gray-400 text-sm mb-1">Budget Total Max</div>
                <div class="text-2xl font-bold" id="totalBudget">$0</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-gray-400 text-sm mb-1">Paires Actives</div>
                <div class="text-2xl font-bold" id="activePairs">0/0</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-gray-400 text-sm mb-1">Achats Effectués</div>
                <div class="text-2xl font-bold" id="totalPurchases">0</div>
            </div>
            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                <div class="text-gray-400 text-sm mb-1">Statut</div>
                <div class="text-2xl font-bold flex items-center gap-2" id="status">
                    <div class="w-3 h-3 bg-gray-500 rounded-full"></div> Arrêté
                </div>
            </div>
        </div>

        <!-- Pairs Grid -->
        <div id="pairsGrid" class="grid grid-cols-2 gap-4 mb-6">
            <!-- Dynamically loaded -->
        </div>

        <!-- Logs -->
        <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">📋 Journal d'activité</h2>
                <button onclick="clearLogs()" class="text-sm text-gray-400 hover:text-white transition">
                    Effacer
                </button>
            </div>
            <div id="logs" class="space-y-2 max-h-64 overflow-y-auto">
                <div class="p-3 rounded text-sm bg-slate-700 text-gray-300">
                    <span class="text-gray-500 mr-2">[--:--:--]</span>
                    En attente de connexion...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Détection automatique de l'URL du serveur
        const API_URL = window.location.origin;
        console.log('🌐 API URL:', API_URL);
        
        const socket = io(API_URL, {
            transports: ['websocket', 'polling']
        });
        
        let isRunning = false;
        let pairs = [];
        let config = {};

        // WebSocket listeners
        socket.on('connect', () => {
            addLog('success', '✅ Connecté au serveur');
            console.log('Socket connecté, ID:', socket.id);
            loadConfig();
        });

        socket.on('connect_error', (error) => {
            addLog('error', `❌ Erreur de connexion: ${error.message}`);
            console.error('Erreur socket:', error);
        });

        socket.on('disconnect', () => {
            addLog('error', '❌ Déconnecté du serveur');
            console.log('Socket déconnecté');
        });

        socket.on('log', (log) => {
            addLog(log.type, log.message);
        });

        socket.on('status', (status) => {
            console.log('Status reçu:', status);
            updateStatus(status);
        });

        socket.on('pairs-update', (pairsData) => {
            console.log('Pairs update reçu:', pairsData);
            updatePairs(pairsData);
        });

        // Load configuration
        async function loadConfig() {
            try {
                const res = await fetch(`${API_URL}/api/config`);
                const data = await res.json();
                config = data;
                
                // Ne pas écraser les paires si on a déjà des données
                if (pairs.length === 0) {
                    pairs = data.pairs;
                }
                
                // Toujours charger l'état actuel des paires depuis l'API
                const pairsRes = await fetch(`${API_URL}/api/pairs`);
                const pairsState = await pairsRes.json();
                
                console.log('État des paires chargé:', pairsState);
                
                // Fusionner les configs avec l'état actuel
                pairs = data.pairs.map(configPair => {
                    const statePair = pairsState.find(p => p.id === configPair.id);
                    return {
                        ...configPair,
                        ...statePair
                    };
                });
                
                renderPairs();
                updateStats();
            } catch (error) {
                addLog('error', `Erreur de chargement: ${error.message}`);
            }
        }

        // Save configuration (only pairs config, not global settings)
        async function saveConfig() {
            try {
                const res = await fetch(`${API_URL}/api/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pairs })
                });
                
                if (res.ok) {
                    addLog('success', '✅ Configuration des paires sauvegardée');
                }
            } catch (error) {
                addLog('error', `Erreur de sauvegarde: ${error.message}`);
            }
        }

        // Toggle bot
        async function toggleBot() {
            const endpoint = isRunning ? 'stop' : 'start';
            
            console.log(`Tentative de ${endpoint}...`);
            addLog('info', `⏳ ${isRunning ? 'Arrêt' : 'Démarrage'} du bot...`);
            
            try {
                const res = await fetch(`${API_URL}/api/${endpoint}`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                console.log('Réponse du serveur:', data);
                
                if (data.success) {
                    isRunning = !isRunning;
                    updateStartStopButton();
                    addLog('success', `✅ Bot ${isRunning ? 'démarré' : 'arrêté'}`);
                } else {
                    addLog('error', `❌ Échec: ${data.error || 'Erreur inconnue'}`);
                }
            } catch (error) {
                console.error('Erreur lors du toggle:', error);
                addLog('error', `❌ Erreur: ${error.message}`);
            }
        }

        // Update pairs
        function updatePairs(pairsData) {
            console.log('Mise à jour des paires avec:', pairsData);
            pairsData.forEach(pairData => {
                const pair = pairs.find(p => p.id === pairData.id);
                if (pair) {
                    // Mise à jour de toutes les propriétés
                    pair.currentPrice = pairData.currentPrice;
                    pair.lastPurchasePrice = pairData.lastPurchasePrice;
                    pair.ath = pairData.ath;
                    pair.purchaseCount = pairData.purchaseCount;
                    pair.balance = pairData.balance;
                    pair.dropPercentage = pairData.dropPercentage;
                    pair.averagePrice = pairData.averagePrice;
                    pair.totalSpent = pairData.totalSpent;
                    console.log(`Paire ${pair.name} mise à jour:`, pair);
                }
            });
            renderPairs();
            updateStats();
        }

        // Render pairs
        function renderPairs() {
            const grid = document.getElementById('pairsGrid');
            grid.innerHTML = pairs.map(pair => {
                const pnl = pair.averagePrice && pair.currentPrice ? ((pair.currentPrice - pair.averagePrice) / pair.averagePrice) * 100 : 0;
                const pnlColor = pnl >= 0 ? 'text-green-400' : 'text-red-400';
                const athDrop = pair.ath && pair.currentPrice ? ((pair.currentPrice - pair.ath) / pair.ath) * 100 : 0;
                const targetPrice = pair.lastPurchasePrice ? pair.lastPurchasePrice * (1 - (pair.dropPercentage / 100)) : pair.currentPrice * (1 - (pair.dropPercentage / 100));
                const readyToBuy = pair.currentPrice <= targetPrice;

                return `
                <div class="bg-slate-800 rounded-lg p-6 border-2 ${pair.enabled ? 'border-purple-500' : 'border-slate-700 opacity-50'}">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-2xl font-bold mb-1">${pair.name}</h3>
                            <div class="text-sm text-gray-400">Balance: ${parseFloat(pair.balance || 0).toFixed(4)}</div>
                        </div>
                        <button onclick="togglePair(${pair.id})" 
                                class="px-4 py-2 rounded transition ${pair.enabled ? 'bg-green-600 hover:bg-green-500' : 'bg-slate-600 hover:bg-slate-500'}"
                                ${isRunning ? 'disabled' : ''}>
                            ${pair.enabled ? 'ON' : 'OFF'}
                        </button>
                    </div>

                    ${pair.currentPrice ? `
                        <div class="space-y-3">
                            <!-- Ligne 1: Prix actuel | ATH -->
                            <div class="grid grid-cols-2 gap-3">
                                <div class="p-3 bg-slate-700 rounded">
                                    <div class="text-sm text-gray-400">Prix actuel</div>
                                    <div class="text-xl font-bold">${pair.currentPrice.toFixed(2)}</div>
                                </div>
                                <div class="p-3 bg-slate-700 rounded border border-orange-500">
                                    <div class="text-sm text-orange-400">ATH 🔥</div>
                                    <div class="text-xl font-bold text-orange-400">${(pair.ath || 0).toFixed(2)}</div>
                                </div>
                            </div>

                            <!-- Ligne 2: Prix moyen & P&L -->
                            ${pair.averagePrice ? `
                            <div class="p-3 rounded bg-slate-700 border border-blue-500">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-blue-300">Prix moyen</div>
                                    <div class="text-lg font-bold">${pair.averagePrice.toFixed(2)}</div>
                                </div>
                                <div class="flex items-center justify-between mt-1">
                                    <div class="text-sm text-gray-400">P&L</div>
                                    <div class="text-lg font-bold ${pnlColor}">${pnl.toFixed(2)}%</div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- Ligne 3: Variation ATH + Objectif -->
                            <div class="p-3 rounded ${readyToBuy ? 'bg-green-900/30 border border-green-600' : 'bg-slate-700'}">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm ${readyToBuy ? 'text-green-300' : 'text-gray-300'}">
                                        ${readyToBuy ? '🎯 Prêt à acheter!' : `Depuis ATH: <span class="font-bold text-red-400">${athDrop.toFixed(2)}%</span>`}
                                    </div>
                                    <div class="text-sm text-gray-400">
                                        Objectif: <span class="font-bold">${targetPrice.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="p-3 bg-blue-900/30 border border-blue-600 rounded">
                            <div class="text-sm text-blue-300">⏳ En attente de données...</div>
                        </div>
                    `}

                    <div class="mt-6">
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Montant (USDC)</label>
                                <input type="number" value="${pair.purchaseAmount}" 
                                       onchange="updatePairConfig(${pair.id}, 'purchaseAmount', this.value)"
                                       ${isRunning ? 'disabled' : ''}
                                       class="w-full px-3 py-2 bg-slate-700 rounded text-sm border border-slate-600 focus:border-purple-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Max Achats</label>
                                <input type="number" value="${pair.maxPurchases}" 
                                       onchange="updatePairConfig(${pair.id}, 'maxPurchases', this.value)"
                                       ${isRunning ? 'disabled' : ''}
                                       class="w-full px-3 py-2 bg-slate-700 rounded text-sm border border-slate-600 focus:border-purple-500 outline-none">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs text-gray-400 mb-1">% Baisse déclenchement</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" 
                                           value="${pair.dropPercentage || 2}" 
                                           step="0.1"
                                           min="0.1"
                                           max="20"
                                           onchange="updatePairConfig(${pair.id}, 'dropPercentage', parseFloat(this.value))"
                                           ${isRunning ? 'disabled' : ''}
                                           class="flex-1 px-3 py-2 bg-slate-700 rounded text-sm border border-slate-600 focus:border-purple-500 outline-none">
                                    <span class="text-sm text-gray-400">%</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm mb-3">
                            <div class="text-gray-400">
                                Achats: ${pair.purchaseCount || 0}/${pair.maxPurchases}
                            </div>
                            <div class="text-gray-400">
                                Budget: ${(parseFloat(pair.purchaseAmount) * pair.maxPurchases).toLocaleString()}
                            </div>
                        </div>

                        <div class="bg-slate-700 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full transition-all" 
                                 style="width: ${((pair.purchaseCount || 0) / pair.maxPurchases) * 100}%"></div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // Update pair config
        function updatePairConfig(id, field, value) {
            const pair = pairs.find(p => p.id === id);
            if (pair) {
                if (field === 'purchaseAmount') {
                    pair[field] = value;
                } else if (field === 'dropPercentage') {
                    pair[field] = parseFloat(value);
                } else {
                    pair[field] = parseInt(value);
                }
                updateStats();
                autoSave();
            }
        }

        // Toggle pair
        function togglePair(id) {
            if (isRunning) return;
            const pair = pairs.find(p => p.id === id);
            if (pair) {
                pair.enabled = !pair.enabled;
                renderPairs();
                updateStats();
            }
        }

        // Update stats
        function updateStats() {
            const totalBudget = pairs.reduce((sum, p) => 
                p.enabled ? sum + (parseFloat(p.purchaseAmount) * p.maxPurchases) : sum, 0
            );
            const activePairs = pairs.filter(p => p.enabled).length;
            const totalPurchases = pairs.reduce((sum, p) => sum + (p.purchaseCount || 0), 0);

            document.getElementById('totalBudget').textContent = `${totalBudget.toLocaleString()}`;
            document.getElementById('activePairs').textContent = `${activePairs}/${pairs.length}`;
            document.getElementById('totalPurchases').textContent = totalPurchases;
        }

        // Update status
        function updateStatus(status) {
            isRunning = status.isRunning;
            updateStartStopButton();
            
            const statusDiv = document.getElementById('status');
            if (isRunning) {
                statusDiv.innerHTML = '<div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div> Actif';
            } else {
                statusDiv.innerHTML = '<div class="w-3 h-3 bg-gray-500 rounded-full"></div> Arrêté';
            }
        }

        // Update start/stop button
        function updateStartStopButton() {
            const btn = document.getElementById('startStopBtn');
            if (isRunning) {
                btn.className = 'px-6 py-3 bg-red-600 hover:bg-red-500 rounded-lg font-semibold transition';
                btn.innerHTML = '⏸️ Arrêter';
            } else {
                btn.className = 'px-6 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-semibold transition';
                btn.innerHTML = '▶️ Démarrer';
            }
        }

        // Add log
        function addLog(type, message) {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            
            const logClass = type === 'error' ? 'bg-red-900/30 text-red-300' :
                           type === 'success' ? 'bg-green-900/30 text-green-300' :
                           'bg-slate-700 text-gray-300';
            
            const logHTML = `
                <div class="p-3 rounded text-sm ${logClass}">
                    <span class="text-gray-500 mr-2">[${time}]</span>
                    ${message}
                </div>
            `;
            
            logsDiv.insertAdjacentHTML('afterbegin', logHTML);
            
            // Keep only last 50 logs
            const logs = logsDiv.children;
            while (logs.length > 50) {
                logsDiv.removeChild(logs[logs.length - 1]);
            }
        }

        // Sell tokens
        async function sellTokens(pairId) {
            const percentage = parseInt(document.getElementById(`sell-range-${pairId}`).value);
            const pair = pairs.find(p => p.id === pairId);
            
            if (!pair) {
                addLog('error', 'Paire non trouvée');
                return;
            }

            if (!confirm(`Vendre ${percentage}% de ${pair.name} (${(parseFloat(pair.balance) * percentage / 100).toFixed(4)} ${pair.name}) ?`)) {
                return;
            }

            addLog('info', `⏳ Vente de ${percentage}% de ${pair.name}...`);

            try {
                const res = await fetch(`${API_URL}/api/sell`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pairId, percentage })
                });

                const data = await res.json();

                if (data.success) {
                    addLog('success', `✅ Vente réussie: ${data.amountSold} ${pair.name} → ${data.usdcReceived} USDC`);
                    // Forcer la mise à jour de la balance
                    setTimeout(() => {
                        fetch(`${API_URL}/api/pairs`)
                            .then(r => r.json())
                            .then(pairsData => updatePairs(pairsData));
                    }, 2000);
                } else {
                    addLog('error', `❌ Erreur vente: ${data.error}`);
                }
            } catch (error) {
                addLog('error', `❌ Erreur: ${error.message}`);
            }
        }

        // Sell all positions
        async function sellAllPositions() {
            const pairsWithBalance = pairs.filter(p => parseFloat(p.balance || 0) > 0);
            
            if (pairsWithBalance.length === 0) {
                addLog('error', '❌ Aucune position à vendre');
                return;
            }

            const totalValue = pairsWithBalance.reduce((sum, p) => {
                const value = parseFloat(p.balance) * (p.currentPrice || 0);
                return sum + value;
            }, 0);

            const message = `Vendre TOUTES les positions ?\n\n` +
                pairsWithBalance.map(p => {
                    const value = (parseFloat(p.balance) * (p.currentPrice || 0)).toFixed(2);
                    return `• ${p.name}: ${parseFloat(p.balance).toFixed(4)} (~${value})`;
                }).join('\n') +
                `\n\nValeur totale estimée: ~${totalValue.toFixed(2)}`;

            if (!confirm(message)) {
                return;
            }

            addLog('info', '🔄 Vente de toutes les positions en cours...');

            let successCount = 0;
            let totalUSDC = 0;

            for (const pair of pairsWithBalance) {
                addLog('info', `⏳ Vente de ${pair.name}...`);
                
                try {
                    const res = await fetch(`${API_URL}/api/sell`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pairId: pair.id, percentage: 100 })
                    });

                    const data = await res.json();

                    if (data.success) {
                        successCount++;
                        totalUSDC += parseFloat(data.usdcReceived);
                        addLog('success', `✅ ${pair.name}: ${data.amountSold} → ${data.usdcReceived} USDC`);
                    } else {
                        addLog('error', `❌ ${pair.name}: ${data.error}`);
                    }
                } catch (error) {
                    addLog('error', `❌ ${pair.name}: ${error.message}`);
                }

                // Attendre un peu entre chaque vente
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            addLog('success', `🎉 Vente terminée: ${successCount}/${pairsWithBalance.length} positions vendues`);
            addLog('success', `💵 Total reçu: ${totalUSDC.toFixed(2)} USDC`);

            // Mettre à jour l'interface
            setTimeout(() => {
                fetch(`${API_URL}/api/pairs`)
                    .then(r => r.json())
                    .then(pairsData => updatePairs(pairsData));
            }, 2000);
        }

        // Refresh data manually
        async function refreshData() {
            addLog('info', '🔄 Actualisation des données...');
            try {
                const pairsRes = await fetch(`${API_URL}/api/pairs`);
                const pairsState = await pairsRes.json();
                updatePairs(pairsState);
                addLog('success', '✅ Données actualisées');
            } catch (error) {
                addLog('error', `❌ Erreur actualisation: ${error.message}`);
            }
        }

        // Auto-refresh every 30 seconds when not running
        setInterval(() => {
            if (!isRunning) {
                refreshData();
            }
        }, 30000);

        // Clear logs
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Auto-save pairs config on change
        let saveTimeout;
        function autoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveConfig();
            }, 1000);
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('🚀 Page chargée');
            console.log('API_URL:', API_URL);
            console.log('Socket.io version:', io.version);
            addLog('info', '🚀 Interface chargée');
        });

        // Test de connexion au chargement
        window.addEventListener('DOMContentLoaded', () => {
            console.log('📄 DOM chargé');
            
            // Test API
            fetch(`${API_URL}/api/status`)
                .then(res => res.json())
                .then(data => {
                    console.log('✅ API répond:', data);
                    addLog('success', '✅ API accessible');
                })
                .catch(err => {
                    console.error('❌ Erreur API:', err);
                    addLog('error', '❌ Impossible de joindre le serveur');
                });
        });
    </script>
</body>
</html>
